--[[ 
    BEAR HUB - FIXED FOR BLOX FRUITS
    - Style: Giữ nguyên gốc.
    - Logic: Đã nâng cấp lên RenderStepped để bypass cơ chế reset của Blox Fruits.
]]

-- 1. DỊCH VỤ
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService") -- Thêm RunService để chạy siêu nhanh
local Player = Players.LocalPlayer or Players.PlayerAdded:Wait()

-- Đợi PlayerGui an toàn
local PlayerGui = Player:WaitForChild("PlayerGui")

-- 2. DỌN DẸP GUI CŨ
for _, v in pairs(PlayerGui:GetChildren()) do
    if v.Name == "BearHub_Dropdown" then v:Destroy() end
end

-- 3. TẠO GUI (GIỮ NGUYÊN STYLE CŨ)
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "BearHub_Dropdown"
ScreenGui.Parent = PlayerGui
ScreenGui.ResetOnSpawn = false
ScreenGui.IgnoreGuiInset = true 
ScreenGui.DisplayOrder = 9999 

-- NÚT TOGGLE
local HomeBarWrapper = Instance.new("TextButton")
HomeBarWrapper.Name = "HomeBarTrigger"
HomeBarWrapper.Parent = ScreenGui
HomeBarWrapper.Size = UDim2.new(0, 120, 0, 40)
HomeBarWrapper.AnchorPoint = Vector2.new(0.5, 0) 
HomeBarWrapper.Position = UDim2.new(0.65, 0, 0, -15) -- Vị trí lệch phải
HomeBarWrapper.BackgroundTransparency = 1
HomeBarWrapper.Text = ""

local HomeBarVisual = Instance.new("Frame")
HomeBarVisual.Parent = HomeBarWrapper
HomeBarVisual.Size = UDim2.new(0, 80, 0, 6)
HomeBarVisual.AnchorPoint = Vector2.new(0.5, 0.5)
HomeBarVisual.Position = UDim2.new(0.5, 0, 0.5, 0) 
HomeBarVisual.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
HomeBarVisual.BackgroundTransparency = 0.4
Instance.new("UICorner", HomeBarVisual).CornerRadius = UDim.new(1, 0)

-- MENU CHÍNH
local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Parent = ScreenGui 
MainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
MainFrame.ClipsDescendants = true
MainFrame.AnchorPoint = Vector2.new(0.5, 0) 
MainFrame.Position = UDim2.new(0.65, 0, 0, 30) 
MainFrame.Size = UDim2.new(0, 150, 0, 165) 
MainFrame.Visible = false
MainFrame.BorderSizePixel = 0
local MainCorner = Instance.new("UICorner")
MainCorner.CornerRadius = UDim.new(0, 8)
MainCorner.Parent = MainFrame

-- CÁC NÚT CHỨC NĂNG
local UIList = Instance.new("UIListLayout")
UIList.Parent = MainFrame
UIList.SortOrder = Enum.SortOrder.LayoutOrder
UIList.Padding = UDim.new(0, 8)
UIList.HorizontalAlignment = Enum.HorizontalAlignment.Center
UIList.VerticalAlignment = Enum.VerticalAlignment.Center

local function createInput(name, placeholder, order)
    local InputBox = Instance.new("TextBox")
    InputBox.Name = name
    InputBox.Parent = MainFrame
    InputBox.LayoutOrder = order
    InputBox.Size = UDim2.new(0, 130, 0, 30)
    InputBox.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    InputBox.TextColor3 = Color3.fromRGB(255, 255, 255)
    InputBox.PlaceholderText = placeholder
    InputBox.Text = ""
    InputBox.Font = Enum.Font.SourceSansBold
    InputBox.TextSize = 14
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = InputBox
    return InputBox
end

local SpeedInput = createInput("SpeedInput", "Speed (Default: 16)", 1)
local JumpInput = createInput("JumpInput", "Jump (Default: 50)", 2)

local ApplyBtn = Instance.new("TextButton")
ApplyBtn.Name = "ApplyBtn"
ApplyBtn.Parent = MainFrame
ApplyBtn.LayoutOrder = 3
ApplyBtn.Size = UDim2.new(0, 130, 0, 35)
ApplyBtn.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
ApplyBtn.TextColor3 = Color3.fromRGB(25, 25, 25)
ApplyBtn.Text = "APPLY"
ApplyBtn.Font = Enum.Font.SourceSansBold
ApplyBtn.TextSize = 16
Instance.new("UICorner", ApplyBtn).CornerRadius = UDim.new(0, 6)

----------------------------------------------------------------
-- D. LOGIC MỚI (FIX CHO BLOX FRUITS)
----------------------------------------------------------------

-- Toggle Menu
local isMenuOpen = false
HomeBarWrapper.MouseButton1Click:Connect(function()
    isMenuOpen = not isMenuOpen
    MainFrame.Visible = isMenuOpen
    TweenService:Create(HomeBarVisual, TweenInfo.new(0.15), {BackgroundTransparency = 0.1}):Play()
    task.wait(0.15)
    TweenService:Create(HomeBarVisual, TweenInfo.new(0.15), {BackgroundTransparency = 0.4}):Play()
end)

local active = false
local connection = nil -- Biến lưu kết nối vòng lặp

-- Hàm set chỉ số mạnh mẽ hơn
local function setStats()
    local char = Player.Character
    if not char then return end
    local hum = char:FindFirstChild("Humanoid")
    if not hum then return end

    pcall(function()
        -- Xử lý Speed
        local sVal = tonumber(SpeedInput.Text)
        if sVal then 
            hum.WalkSpeed = sVal 
        end

        -- Xử lý Jump (Blox Fruit cần force cả 2 loại nhảy)
        local jVal = tonumber(JumpInput.Text)
        if jVal then 
            hum.UseJumpPower = true 
            hum.JumpPower = jVal
            -- Force thêm JumpHeight phòng trường hợp game đổi cơ chế vật lý
            hum.JumpHeight = jVal / 5 -- (Ước lượng chuyển đổi)
        end
    end)
end

ApplyBtn.MouseButton1Click:Connect(function()
    active = not active
    local char = Player.Character
    
    if active then
        -- BẬT: Dùng RenderStepped để spam chỉ số mỗi khung hình
        ApplyBtn.Text = "STOP"
        ApplyBtn.BackgroundColor3 = Color3.fromRGB(255, 80, 80)
        
        -- Ngắt kết nối cũ nếu có để tránh lag
        if connection then connection:Disconnect() end
        
        -- Tạo vòng lặp siêu nhanh
        connection = RunService.RenderStepped:Connect(function()
            setStats()
        end)
    else
        -- TẮT: Ngắt vòng lặp và trả về mặc định
        ApplyBtn.Text = "APPLY"
        ApplyBtn.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
        
        if connection then 
            connection:Disconnect() 
            connection = nil
        end
        
        if char and char:FindFirstChild("Humanoid") then
            char.Humanoid.WalkSpeed = 16
            char.Humanoid.JumpPower = 50
            char.Humanoid.JumpHeight = 7.2
        end
    end
end)

-- Thông báo
game.StarterGui:SetCore("SendNotification", {
    Title = "Bear Hub",
    Text = "Blox Fruits Logic Fixed!",
    Duration = 3
})
