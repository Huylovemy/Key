--[[
    Super Clean iOS Noclip UI - FIXED VERSION
    Fix 1: Tự động bật lại va chạm (Collision) khi tắt nút.
    Fix 2: Phân biệt rõ ràng giữa "Kéo nút" và "Bấm nút" để tránh bị kẹt.
]]

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")

local LocalPlayer = Players.LocalPlayer
local noclipEnabled = false

--// 1. DỌN DẸP UI CŨ //--
for _, gui in pairs(CoreGui:GetChildren()) do
    if gui.Name == "GeminiCleanUI" then
        gui:Destroy()
    end
end

--// 2. TẠO GIAO DIỆN //--
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "GeminiCleanUI"
if syn and syn.protect_gui then
    syn.protect_gui(ScreenGui)
    ScreenGui.Parent = CoreGui
elseif gethui then
    ScreenGui.Parent = gethui()
else
    ScreenGui.Parent = CoreGui
end

local ToggleButton = Instance.new("TextButton")
ToggleButton.Name = "Toggle"
ToggleButton.Text = ""
ToggleButton.Size = UDim2.new(0, 70, 0, 36)
ToggleButton.Position = UDim2.new(0.5, -35, 0, 10) 
ToggleButton.BackgroundColor3 = Color3.fromRGB(35, 35, 40)
ToggleButton.BorderSizePixel = 0
ToggleButton.AutoButtonColor = false
ToggleButton.Parent = ScreenGui

local UICorner_Toggle = Instance.new("UICorner")
UICorner_Toggle.CornerRadius = UDim.new(1, 0)
UICorner_Toggle.Parent = ToggleButton

local UIStroke = Instance.new("UIStroke")
UIStroke.Color = Color3.fromRGB(80, 80, 80)
UIStroke.Thickness = 1.5
UIStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
UIStroke.Parent = ToggleButton

local Knob = Instance.new("Frame")
Knob.Name = "Knob"
Knob.Size = UDim2.new(0, 30, 0, 30)
Knob.Position = UDim2.new(0, 3, 0.5, -15)
Knob.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
Knob.BorderSizePixel = 0
Knob.Parent = ToggleButton

local UICorner_Knob = Instance.new("UICorner")
UICorner_Knob.CornerRadius = UDim.new(1, 0)
UICorner_Knob.Parent = Knob

--// 3. CHỨC NĂNG (LOGIC) //--

-- Hàm xử lý bật/tắt
local function toggleState()
    noclipEnabled = not noclipEnabled
    
    local tweenInfo = TweenInfo.new(0.3, Enum.EasingStyle.Back, Enum.EasingDirection.Out)
    
    if noclipEnabled then
        -- TRẠNG THÁI: BẬT (Xanh lá)
        TweenService:Create(ToggleButton, tweenInfo, {BackgroundColor3 = Color3.fromRGB(50, 205, 75)}):Play()
        TweenService:Create(Knob, tweenInfo, {Position = UDim2.new(1, -33, 0.5, -15)}):Play()
        TweenService:Create(UIStroke, tweenInfo, {Transparency = 1}):Play()
    else
        -- TRẠNG THÁI: TẮT (Xám) & KHÔI PHỤC VA CHẠM
        TweenService:Create(ToggleButton, tweenInfo, {BackgroundColor3 = Color3.fromRGB(35, 35, 40)}):Play()
        TweenService:Create(Knob, tweenInfo, {Position = UDim2.new(0, 3, 0.5, -15)}):Play()
        TweenService:Create(UIStroke, tweenInfo, {Transparency = 0}):Play()
        
        -- QUAN TRỌNG: Bật lại va chạm cho nhân vật ngay lập tức
        if LocalPlayer.Character then
            for _, part in pairs(LocalPlayer.Character:GetDescendants()) do
                if part:IsA("BasePart") then
                    part.CanCollide = true
                end
            end
        end
    end
end

-- Vòng lặp Noclip
RunService.Stepped:Connect(function()
    if noclipEnabled and LocalPlayer.Character then
        for _, part in pairs(LocalPlayer.Character:GetDescendants()) do
            if part:IsA("BasePart") and part.CanCollide == true then
                part.CanCollide = false
            end
        end
    end
end)

--// 4. XỬ LÝ CẢM ỨNG THÔNG MINH (Smart Touch) //--
-- Logic này giúp phân biệt: Chạm nhẹ là Bật/Tắt, Kéo đi là Di chuyển nút
local dragging = false
local dragStart, startPos
local isMoved = false -- Biến kiểm tra xem có di chuyển hay không

ToggleButton.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        isMoved = false -- Reset trạng thái di chuyển
        dragStart = input.Position
        startPos = ToggleButton.Position
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
                -- Nếu ngón tay không di chuyển quá 5 pixel, tính là CLICK
                if not isMoved then
                    toggleState()
                end
            end
        end)
    end
end)

ToggleButton.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
        if dragging then
            local delta = input.Position - dragStart
            -- Nếu di chuyển quá 5 pixel, tính là KÉO (không phải click)
            if delta.Magnitude > 5 then
                isMoved = true
                ToggleButton.Position = UDim2.new(
                    startPos.X.Scale, startPos.X.Offset + delta.X,
                    startPos.Y.Scale, startPos.Y.Offset + delta.Y
                )
            end
        end
    end
end)
